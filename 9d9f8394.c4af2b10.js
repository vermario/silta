(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{81:function(e,t,n){"use strict";n.r(t),n.d(t,"frontMatter",(function(){return o})),n.d(t,"metadata",(function(){return s})),n.d(t,"toc",(function(){return c})),n.d(t,"default",(function(){return u}));var r=n(3),a=n(7),i=(n(0),n(97)),o={id:"troubleshooting",title:"CircleCI build issues",sidebar_label:"Troubleshooting"},s={unversionedId:"troubleshooting",id:"troubleshooting",isDocsHomePage:!1,title:"CircleCI build issues",description:"Helm release fails due to existing resources",source:"@site/docs/troubleshooting.md",slug:"/troubleshooting",permalink:"/silta/docs/troubleshooting",editUrl:"https://github.com/wunderio/silta/tree/master/docs/troubleshooting.md",version:"current",sidebar_label:"Troubleshooting",sidebar:"someSidebar",previous:{title:"Silta examples",permalink:"/silta/docs/silta-examples"}},c=[{value:"&quot;upstream connect error&quot; when connecting via HTTP",id:"upstream-connect-error-when-connecting-via-http",children:[]},{value:"&quot;Error: Connection refused&quot; when connecting via SSH",id:"error-connection-refused-when-connecting-via-ssh",children:[]},{value:"Timeout without error when connecting via SSH",id:"timeout-without-error-when-connecting-via-ssh",children:[]},{value:"username@X.X.X.X: Permission denied (publickey).",id:"usernamexxxx-permission-denied-publickey",children:[]},{value:"Mariadb or Elasticsearch running out of disk space",id:"mariadb-or-elasticsearch-running-out-of-disk-space",children:[]},{value:"Drupal 7 migration",id:"drupal-7-migration",children:[]}],l={toc:c};function u(e){var t=e.components,n=Object(a.a)(e,["components"]);return Object(i.b)("wrapper",Object(r.a)({},l,n,{components:t,mdxType:"MDXLayout"}),Object(i.b)("h1",{id:"helm-release-fails-due-to-existing-resources"},"Helm release fails due to existing resources"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'Error: kind PersistentVolume with the name "project-123--branchname-someresource" already exists in the cluster and wasn\'t defined in the previous release.\n')),Object(i.b)("p",null,"This error happens when a release that created a new resource failed.\nThe resource that is now in the way needs to be deleted, please ask someone with direct access to the cluster to do that."),Object(i.b)("h1",{id:"issues-with-the-deployed-environments"},"Issues with the deployed environments"),Object(i.b)("h2",{id:"upstream-connect-error-when-connecting-via-http"},'"upstream connect error" when connecting via HTTP'),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"upstream connect error or disconnect/reset before headers\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What happened:")," The application pod is in an unready state, so ambassador (the API gateway) is not sending traffic to it."),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What to do:")," This could be because the deployment is not complete, or there is a problem with your application.\nCheck the deployment logs in CircleCI. Please contact the ops team if the issue persists."),Object(i.b)("h2",{id:"error-connection-refused-when-connecting-via-ssh"},'"Error: Connection refused" when connecting via SSH'),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"channel 0: open failed: connect failed: Connection refused\nstdio forwarding failed\nssh_exchange_identification: Connection closed by remote host\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"What happened:")," The ",Object(i.b)("inlineCode",{parentName:"p"},"shell")," pod is not done deploying.\n",Object(i.b)("strong",{parentName:"p"},"What to do:")," Wait for a ten seconds and try again."),Object(i.b)("h2",{id:"timeout-without-error-when-connecting-via-ssh"},"Timeout without error when connecting via SSH"),Object(i.b)("p",null,"You are probably not logged into the VPN."),Object(i.b)("h2",{id:"usernamexxxx-permission-denied-publickey"},Object(i.b)("a",{parentName:"h2",href:"mailto:username@X.X.X.X"},"username@X.X.X.X"),": Permission denied (publickey)."),Object(i.b)("p",null,"Reason: Authentication is based on your GitHub key, but there is trouble reading it."),Object(i.b)("p",null,"Solution: Use the key explicitly using ",Object(i.b)("inlineCode",{parentName:"p"},"-i [path_to_identity_file]")," option:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-bash"},"ssh X.X.X.X -i ~/.ssh/keys/wunder-github.rsa \n")),Object(i.b)("h2",{id:"mariadb-or-elasticsearch-running-out-of-disk-space"},"Mariadb or Elasticsearch running out of disk space"),Object(i.b)("p",null,"Stateful applications like MariaDB or Elasticsearch store their data in volumes backed by Google Persistent Disks. It is possible to resize those disks (only increasing storage is supported), but this is not yet integrated with the process of updating a statefulset.\nYou can change the requested size by setting the ",Object(i.b)("inlineCode",{parentName:"p"},"elasticsearch.volumeClaimTemplate.resources.requests.storage")," or ",Object(i.b)("inlineCode",{parentName:"p"},"mariadb.master.persistence.size")," field in the ",Object(i.b)("inlineCode",{parentName:"p"},"silta.yml")," for the appropriate service (",Object(i.b)("inlineCode",{parentName:"p"},"mariadb")," or ",Object(i.b)("inlineCode",{parentName:"p"},"elasticsearch"),"):"),Object(i.b)("p",null,"MariaDB storage request (re-check correct values with mariadb subchart if needed):"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"mariadb:\n  master:\n    persistence:\n      # Database storage disk space allocation\n      # Request assistance from ops team after changing this on existing deployment.\n      size: 5Gi\n")),Object(i.b)("p",null,"Elasticsearch storage request (re-check correct values with elasticsearch subchart if needed):"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"elasticsearch:\n  volumeClaimTemplate:\n    resources:\n      requests:\n        # Elasticsearch storage disk space allocation\n        # Request assistance from ops team after changing this on existing deployment.\n        storage: 5Gi\n")),Object(i.b)("p",null,"If the size is less than 5G, set it to 5G. If it's 5G or more, double the previous value."),Object(i.b)("p",null,"Due to inability to patch immutable fields in mariadb statefulset, the next build will fail unless cluster administrator runs these commands manually:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'namespace="name-of-repository"\npvc="data-master-mariadb-0" # Find this with kubectl get pvc -n $namespace\nstatefulset="master-mariadb"\n\nkubectl patch pvc -n $namespace $pvc -p \'{"spec": {"resources": {"requests": {"storage": "5Gi"}}}}\'\nkubectl delete statefulset  -n $namespace --cascade=orphan $statefulset\n')),Object(i.b)("p",null,"NOTE: If updating pvc size you are met with error:"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},'error: persistentvolumeclaims "xxx-xxx" could not be patched: persistentvolumeclaims "xxx-xxx" is forbidden: only dynamically provisioned pvc can be resized and the storageclass that provisions the pvc must support resize\n')),Object(i.b)("p",null,'Check that Kubernetes is running at least v1.16 and then edit the corresponding storageclass, "standard" in this case:'),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre"},"kubectl patch storageclass standard -p '{\"allowVolumeExpansion\": true}'\n")),Object(i.b)("h2",{id:"drupal-7-migration"},"Drupal 7 migration"),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Project uses make file for builds"),Object(i.b)("br",{parentName:"p"}),"\n","Have something like this in .circleci/config.yml"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"          codebase-build:\n            - run:\n                name: Build from makefile\n                command: |\n                  composer install\n                  vendor/drush/drush/drush make ~/project/drupal/conf/site.make ~/project/drupal/web/\n                  mkdir -p web/sites/all/modules\n                  cp -r code/modules/custom web/sites/all/modules/\n")),Object(i.b)("p",null,Object(i.b)("strong",{parentName:"p"},"Drush is missing"),Object(i.b)("br",{parentName:"p"}),"\n","Add composer.json in Drupal folder"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-json"},'{\n    "require": {\n        "drush/drush": "8.*"\n    },\n    "extra": {\n        "installer-paths": {\n            "web/": ["type:drupal-core"]\n        }\n    }\n}\n')),Object(i.b)("p",null,"And then in .circleci/config.yml add"),Object(i.b)("pre",null,Object(i.b)("code",{parentName:"pre",className:"language-yaml"},"                command: |\n                  composer install\n")))}u.isMDXComponent=!0},97:function(e,t,n){"use strict";n.d(t,"a",(function(){return p})),n.d(t,"b",(function(){return m}));var r=n(0),a=n.n(r);function i(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,r)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){i(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function c(e,t){if(null==e)return{};var n,r,a=function(e,t){if(null==e)return{};var n,r,a={},i=Object.keys(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||(a[n]=e[n]);return a}(e,t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);for(r=0;r<i.length;r++)n=i[r],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(a[n]=e[n])}return a}var l=a.a.createContext({}),u=function(e){var t=a.a.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},p=function(e){var t=u(e.components);return a.a.createElement(l.Provider,{value:t},e.children)},b={inlineCode:"code",wrapper:function(e){var t=e.children;return a.a.createElement(a.a.Fragment,{},t)}},d=a.a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,i=e.originalType,o=e.parentName,l=c(e,["components","mdxType","originalType","parentName"]),p=u(n),d=r,m=p["".concat(o,".").concat(d)]||p[d]||b[d]||i;return n?a.a.createElement(m,s(s({ref:t},l),{},{components:n})):a.a.createElement(m,s({ref:t},l))}));function m(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var i=n.length,o=new Array(i);o[0]=d;var s={};for(var c in t)hasOwnProperty.call(t,c)&&(s[c]=t[c]);s.originalType=e,s.mdxType="string"==typeof e?e:r,o[1]=s;for(var l=2;l<i;l++)o[l]=n[l];return a.a.createElement.apply(null,o)}return a.a.createElement.apply(null,n)}d.displayName="MDXCreateElement"}}]);